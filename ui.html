<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>A11y Audit Pro</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --background: 0 0% 100%;
      --foreground: 222.2 84% 4.9%;
      --primary: 222.2 47.4% 11.2%;
      --primary-foreground: 210 40% 98%;
      --secondary: 210 40% 96.1%;
      --secondary-foreground: 222.2 47.4% 11.2%;
      --success: 142 71% 45%;
      --success-foreground: 355.7 100% 97.3%;
      --warning: 48 96% 53%;
      --warning-foreground: 26 90% 10%;
      --destructive: 0 84.2% 60.2%;
      --destructive-foreground: 210 40% 98%;
      --muted: 210 40% 96.1%;
      --muted-foreground: 215.4 16.3% 46.9%;
      --border: 214.3 31.8% 91.4%;
      --radius: 0.5rem;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      font-size: 14px;
      color: hsl(var(--foreground));
      background: hsl(var(--background));
      line-height: 1.5;
    }

    .container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .hidden { display: none !important; }

    /* Header */
    .header {
      padding: 12px 16px;
      border-bottom: 1px solid hsl(var(--border));
      background: hsl(var(--background));
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left { flex: 1; }

    .header-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .header-subtitle {
      font-size: 11px;
      color: hsl(var(--muted-foreground));
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: hsl(var(--primary));
      color: hsl(var(--primary-foreground));
    }

    .btn-primary:hover:not(:disabled) {
      background: hsl(var(--primary) / 0.9);
    }

    .btn-secondary {
      background: hsl(var(--secondary));
      color: hsl(var(--secondary-foreground));
    }

    .btn-secondary:hover:not(:disabled) {
      background: hsl(var(--secondary) / 0.8);
    }

    .btn-ghost {
      background: transparent;
      color: hsl(var(--foreground));
    }

    .btn-ghost:hover:not(:disabled) {
      background: hsl(var(--muted));
    }

    .btn-destructive {
      background: hsl(var(--destructive));
      color: hsl(var(--destructive-foreground));
    }

    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-lg { padding: 12px 20px; font-size: 15px; }
    .btn-full { width: 100%; }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid hsl(var(--border));
      background: hsl(var(--background));
    }

    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: hsl(var(--muted-foreground));
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }

    .tab-btn:hover {
      color: hsl(var(--foreground));
      background: hsl(var(--muted));
    }

    .tab-btn.active {
      color: hsl(var(--primary));
      border-bottom-color: hsl(var(--primary));
    }

    .tab-content {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    /* Cards */
    .card {
      background: hsl(var(--background));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 16px;
    }

    .card-header {
      padding: 12px 16px;
      border-bottom: 1px solid hsl(var(--border));
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .card-description {
      font-size: 12px;
      color: hsl(var(--muted-foreground));
    }

    .card-content { padding: 16px; }

    .card-footer {
      padding: 12px 16px;
      border-top: 1px solid hsl(var(--border));
      display: flex;
      gap: 8px;
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-success { background: hsl(var(--success) / 0.1); color: hsl(var(--success)); }
    .badge-warning { background: hsl(var(--warning) / 0.1); color: hsl(var(--warning-foreground)); }
    .badge-destructive { background: hsl(var(--destructive) / 0.1); color: hsl(var(--destructive)); }
    .badge-secondary { background: hsl(var(--secondary)); color: hsl(var(--secondary-foreground)); }

    /* Form Elements */
    .select, .input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      font-size: 14px;
      transition: all 0.2s;
    }

    .select:focus, .input:focus {
      outline: none;
      border-color: hsl(var(--primary));
      box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 6px 0;
    }

    .checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: hsl(var(--border));
      outline: none;
      appearance: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      appearance: none;
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: hsl(var(--primary));
      cursor: pointer;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: hsl(var(--muted-foreground));
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: hsl(var(--foreground));
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 32px 24px;
    }

    .spinner {
      border: 3px solid hsl(var(--border));
      border-top: 3px solid hsl(var(--primary));
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      min-width: 260px;
      background: hsl(var(--background));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: 0 10px 25px hsl(var(--foreground) / 0.1);
      display: flex;
      gap: 10px;
      align-items: start;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .toast-success { border-left: 4px solid hsl(var(--success)); }
    .toast-error { border-left: 4px solid hsl(var(--destructive)); }
    .toast-warning { border-left: 4px solid hsl(var(--warning)); }

    .toast-icon { font-size: 18px; flex-shrink: 0; }
    .toast-content { flex: 1; }
    .toast-title { font-weight: 600; font-size: 13px; }
    .toast-message { font-size: 12px; color: hsl(var(--muted-foreground)); }
    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: hsl(var(--muted-foreground));
      padding: 0;
    }

    /* Issue Cards */
    .issue-card {
      background: hsl(var(--background));
      border: 1px solid hsl(var(--border));
      border-left: 4px solid;
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
    }

    .issue-card.fail {
      border-left-color: hsl(var(--destructive));
      background: hsl(var(--destructive) / 0.03);
    }

    .issue-card.warning {
      border-left-color: hsl(var(--warning));
      background: hsl(var(--warning) / 0.03);
    }

    .issue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .issue-title { font-weight: 600; font-size: 14px; }

    .issue-details {
      font-size: 12px;
      color: hsl(var(--muted-foreground));
      margin-bottom: 8px;
      line-height: 1.6;
    }

    .issue-fix {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid hsl(var(--border));
    }

    /* Collapsible Section */
    .collapsible {
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: hsl(var(--muted) / 0.3);
      cursor: pointer;
      user-select: none;
    }

    .collapsible-header:hover {
      background: hsl(var(--muted) / 0.5);
    }

    .collapsible-title {
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .collapsible-chevron {
      font-size: 12px;
      transition: transform 0.2s;
    }

    .collapsible.open .collapsible-chevron {
      transform: rotate(180deg);
    }

    .collapsible-content {
      padding: 16px;
      display: none;
    }

    .collapsible.open .collapsible-content {
      display: block;
    }

    /* Settings Group */
    .settings-group { margin-bottom: 20px; }
    .settings-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    /* Info Box */
    .info-box {
      background: hsl(var(--primary) / 0.05);
      border-left: 3px solid hsl(var(--primary));
      padding: 10px 12px;
      margin: 12px 0;
      border-radius: 4px;
      font-size: 12px;
      line-height: 1.5;
    }

    /* History Item */
    .history-item {
      padding: 12px;
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .history-item:hover {
      background: hsl(var(--muted) / 0.5);
      border-color: hsl(var(--primary) / 0.3);
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .history-item-name {
      font-weight: 500;
      font-size: 14px;
    }

    .history-item-time {
      font-size: 11px;
      color: hsl(var(--muted-foreground));
    }

    .history-item-stats {
      display: flex;
      gap: 8px;
    }

    /* Progress Bar */
    .progress-container {
      margin: 16px 0;
    }

    .progress-bar {
      height: 6px;
      background: hsl(var(--border));
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: hsl(var(--primary));
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 12px;
      color: hsl(var(--muted-foreground));
      margin-top: 6px;
      text-align: center;
    }

    /* Frame Selection Card */
    .frame-card {
      padding: 16px;
      border: 2px dashed hsl(var(--border));
      border-radius: var(--radius);
      text-align: center;
      margin-bottom: 16px;
    }

    /* Overlay Toggle on Analyze Page */
    .overlay-toggle-container {
      margin: 16px 0;
      padding: 12px 16px;
      background: hsl(var(--muted) / 0.3);
      border-radius: var(--radius);
      border: 1px solid hsl(var(--border));
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-size: 14px;
      color: hsl(var(--foreground));
      user-select: none;
    }

    .toggle-label input[type="checkbox"] {
      display: none;
    }

    .toggle-slider {
      position: relative;
      width: 44px;
      height: 24px;
      background: hsl(var(--border));
      border-radius: 12px;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }

    .toggle-slider::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .toggle-label input:checked + .toggle-slider {
      background: hsl(var(--primary));
    }

    .toggle-label input:checked + .toggle-slider::after {
      transform: translateX(20px);
    }

    .toggle-text {
      font-weight: 500;
    }

    .toggle-hint {
      font-size: 11px;
      color: hsl(var(--muted-foreground));
      margin-top: 2px;
    }

    .frame-card.selected {
      border-style: solid;
      border-color: hsl(var(--primary));
      background: hsl(var(--primary) / 0.03);
    }

    .frame-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .frame-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .frame-status {
      font-size: 12px;
      color: hsl(var(--muted-foreground));
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="main-app" style="display: flex; flex-direction: column; min-height: 100vh;">
      <!-- Header -->
      <div class="header">
        <div class="header-left">
          <div class="header-title">üéØ A11y Audit Pro</div>
          <div class="header-subtitle" id="user-plan-badge">Free Plan</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="analyze" onclick="switchTab('analyze')">Analyze</button>
        <button class="tab-btn" data-tab="history" onclick="switchTab('history')">History</button>
        <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">Settings</button>
      </div>

      <!-- ==================== ANALYZE TAB ==================== -->
      <div class="tab-content" id="analyze-tab">
        
        <!-- Frame Selection -->
        <div id="frame-card" class="frame-card">
          <div class="frame-icon">üìÑ</div>
          <div class="frame-name" id="frame-name">No Frame Selected</div>
          <div class="frame-status" id="frame-status">Select a frame in Figma to analyze</div>
        </div>

        <!-- Checks Section (Collapsible - Open by Default) -->
        <div class="collapsible open" id="checks-collapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('checks-collapsible')">
            <span class="collapsible-title">
              üé® What to Check
            </span>
            <span class="collapsible-chevron">‚ñº</span>
          </div>
          <div class="collapsible-content">
            <label class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="check-color-contrast" checked>
              <span>Color Contrast</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="check-text-spacing" checked>
              <span>Text Spacing</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="check-line-height" checked>
              <span>Line Height</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="check-paragraph-spacing" checked>
              <span>Paragraph Spacing</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="check-non-text-contrast" checked>
              <span>Non-text Contrast</span>
            </label>
            <label class="checkbox-wrapper" style="opacity: 0.5;">
              <input type="checkbox" class="checkbox" disabled>
              <span>Touch Target Size (Coming Soon)</span>
            </label>
          </div>
        </div>

        <!-- Overlay Toggle (Quick Access) -->
        <div class="overlay-toggle-container">
          <label class="toggle-label">
            <input type="checkbox" id="show-overlay-toggle" checked onchange="toggleOverlay(this.checked)">
            <span class="toggle-slider"></span>
            <div>
              <span class="toggle-text">Show Visual Overlays</span>
              <div class="toggle-hint">Highlight issues on the canvas</div>
            </div>
          </label>
        </div>

        <!-- Analyze Button -->
        <button class="btn btn-primary btn-full btn-lg" id="analyze-btn" onclick="analyzeFrame()" disabled>
          üîç Analyze Frame
        </button>

        <!-- Progress (Hidden by default) -->
        <div id="progress-container" class="progress-container hidden">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
          <div class="progress-text" id="progress-text">Analyzing...</div>
        </div>

        <!-- Results Container -->
        <div id="results-container" style="margin-top: 16px;">
          <!-- Results will be inserted here -->
        </div>
      </div>

      <!-- ==================== HISTORY TAB ==================== -->
      <div class="tab-content hidden" id="history-tab">
        <div class="card">
          <div class="card-header">
            <div class="card-title">üìä Analysis History</div>
            <div class="card-description">Your recent accessibility checks</div>
          </div>
          <div class="card-content" id="history-container">
            <!-- History will be loaded here -->
          </div>
        </div>
        <button class="btn btn-ghost btn-full" onclick="clearHistory()">
          üóëÔ∏è Clear History
        </button>
      </div>

      <!-- ==================== SETTINGS TAB ==================== -->
      <div class="tab-content hidden" id="settings-tab">
        
        <!-- WCAG Standard -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">üìã WCAG Standard</div>
            <div class="card-description">Choose your compliance level</div>
          </div>
          <div class="card-content">
            <div class="settings-group">
              <label class="settings-label">Version</label>
              <select class="select" id="wcag-version" onchange="updateWCAGDescription()">
                <option value="2.0">WCAG 2.0</option>
                <option value="2.1" selected>WCAG 2.1 (Recommended)</option>
                <option value="2.2">WCAG 2.2 (Latest)</option>
              </select>
            </div>
            
            <div class="settings-group">
              <label class="settings-label">Level</label>
              <select class="select" id="wcag-level" onchange="updateWCAGDescription()">
                <option value="AA" selected>AA (Standard)</option>
                <option value="AAA">AAA (Strict)</option>
              </select>
            </div>
            
            <div class="info-box" id="wcag-description">
              WCAG 2.1 AA is recommended for most projects. Includes mobile and touch accessibility.
            </div>
          </div>
        </div>

        <!-- Display Options -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">üéØ Display Options</div>
            <div class="card-description">How to show issues</div>
          </div>
          <div class="card-content">
            <label class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="show-overlays" checked>
              <span>Show Visual Overlays</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="group-by-element" checked>
              <span>Group Issues by Element</span>
            </label>
            <label class="checkbox-wrapper">
              <input type="checkbox" class="checkbox" id="show-only-failures">
              <span>Show Only Failing Checks</span>
            </label>
            
            <div class="settings-group" style="margin-top: 16px;">
              <div class="settings-row">
                <label class="settings-label">Overlay Brightness</label>
                <span id="opacity-value">70%</span>
              </div>
              <input type="range" class="slider" id="overlay-opacity" min="0" max="100" value="70" oninput="updateOpacityValue(this.value)">
            </div>
          </div>
        </div>

        <!-- Storage Settings (Simple terminology for designers) -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">üíæ Saved Results</div>
            <div class="card-description">Manage your analysis data</div>
          </div>
          <div class="card-content">
            <div class="settings-group">
              <label class="settings-label">Keep results for</label>
              <select class="select" id="cache-ttl">
                <option value="1">1 day</option>
                <option value="3">3 days</option>
                <option value="7" selected>1 week</option>
                <option value="14">2 weeks</option>
                <option value="30">1 month</option>
              </select>
            </div>
            
            <div class="info-box">
              üí° Previously analyzed frames load instantly. Longer storage = faster re-checks.
            </div>
            
            <button class="btn btn-secondary btn-full" onclick="clearAllCache()" style="margin-top: 12px;">
              üóëÔ∏è Clear All Saved Results
            </button>
          </div>
        </div>

        <!-- Save Settings Button -->
        <button class="btn btn-primary btn-full btn-lg" onclick="saveSettings()">
          üíæ Save Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <script>
    // ==========================================
    // STATE
    // ==========================================
    let isFrameSelected = false;
    let isAnalyzing = false;
    let currentFrameName = '';
    let historyLoadTimeout = null;

    // ==========================================
    // TAB SWITCHING
    // ==========================================
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`${tabName}-tab`).classList.remove('hidden');
      
      if (tabName === 'history') {
        loadHistory();
      } else if (tabName === 'settings') {
        loadSettings();
      }
    }

    // ==========================================
    // COLLAPSIBLE
    // ==========================================
    function toggleCollapsible(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.toggle('open');
        // Save preference
        // Persist UI state via plugin settings in future (removed localStorage for Figma)
      }
    }

    // Restore collapsible state on load
    function restoreCollapsibleState() {
      // Collapsible state persistence removed (figma.clientStorage should be used instead).
      // Keep defaults (open state defined in markup/CSS).
    }

    // ==========================================
    // FRAME SELECTION
    // ==========================================
    function updateFrameCard(name, hasCache) {
      const frameCard = document.getElementById('frame-card');
      const frameName = document.getElementById('frame-name');
      const frameStatus = document.getElementById('frame-status');
      const analyzeBtn = document.getElementById('analyze-btn');

      frameCard.classList.add('selected');
      // Show ONLY the frame name, nothing else
      frameName.textContent = name;
      frameStatus.textContent = hasCache ? '‚úì Has saved results' : 'Ready to analyze';
      analyzeBtn.disabled = false;
      
      isFrameSelected = true;
      currentFrameName = name;
    }

    function clearFrameCard() {
      const frameCard = document.getElementById('frame-card');
      const frameName = document.getElementById('frame-name');
      const frameStatus = document.getElementById('frame-status');
      const analyzeBtn = document.getElementById('analyze-btn');

      frameCard.classList.remove('selected');
      frameName.textContent = 'No Frame Selected';
      frameStatus.textContent = 'Select a frame in Figma to analyze';
      analyzeBtn.disabled = true;
      
      isFrameSelected = false;
      currentFrameName = '';
    }

    // ==========================================
    // ANALYSIS
    // ==========================================
    function analyzeFrame() {
      if (!isFrameSelected || isAnalyzing) return;
      
      isAnalyzing = true;
      
      // Show progress
      document.getElementById('progress-container').classList.remove('hidden');
      document.getElementById('progress-fill').style.width = '0%';
      document.getElementById('progress-text').textContent = 'Starting analysis...';
      document.getElementById('results-container').innerHTML = '';
      document.getElementById('analyze-btn').disabled = true;
      
      const checks = getEnabledChecks();
      const showOverlay = document.getElementById('show-overlays')?.checked ?? true;
      
      console.log('Sending analyze message with checks:', checks);
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'analyze',
          checks: checks,
          showOverlay: showOverlay
        } 
      }, '*');
    }

    function getEnabledChecks() {
      return {
        colorContrast: document.getElementById('check-color-contrast')?.checked ?? true,
        textSpacing: document.getElementById('check-text-spacing')?.checked ?? true,
        lineHeight: document.getElementById('check-line-height')?.checked ?? true,
        paragraphSpacing: document.getElementById('check-paragraph-spacing')?.checked ?? true,
        nonTextContrast: document.getElementById('check-non-text-contrast')?.checked ?? true,
      };
    }

    // ==========================================
    // RESULTS DISPLAY
    // ==========================================
    function displayResults(groupedIssues, totalIssues, fromCache, cacheAge) {
      const container = document.getElementById('results-container');
      
      // Hide progress
      document.getElementById('progress-container').classList.add('hidden');
      document.getElementById('analyze-btn').disabled = false;
      isAnalyzing = false;

      if (!groupedIssues || totalIssues === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <h3>All Checks Passed!</h3>
            <p>No accessibility issues found in this frame.</p>
          </div>
        `;
        return;
      }

      // Count issues
      let failCount = 0;
      let warnCount = 0;
      groupedIssues.forEach(group => {
        group.issues.forEach(issue => {
          if (issue.severity === 'fail') failCount++;
          else warnCount++;
        });
      });

      let html = `
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-content" style="padding: 12px 16px;">
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <strong>Results:</strong>
              ${failCount > 0 ? `<span class="badge badge-destructive">${failCount} Critical</span>` : ''}
              ${warnCount > 0 ? `<span class="badge badge-warning">${warnCount} Warnings</span>` : ''}
              ${fromCache ? `<span class="badge badge-secondary">üíæ ${cacheAge}</span>` : ''}
            </div>
          </div>
        </div>
      `;

      groupedIssues.forEach(group => {
        group.issues.forEach((issue, idx) => {
          html += `
            <div class="issue-card ${issue.severity}">
              <div class="issue-header">
                <span class="issue-title">${issue.issueType}</span>
                <span class="badge badge-${issue.severity === 'fail' ? 'destructive' : 'warning'}">
                  ${issue.severity === 'fail' ? 'FAIL' : 'WARNING'}
                </span>
              </div>
              <div class="issue-details">
                <strong>Element:</strong> ${issue.elementName}<br>
                <strong>Current:</strong> ${issue.currentValue}<br>
                <strong>Required:</strong> ${issue.requiredValue}
              </div>
              ${issue.suggestion ? `
                <div class="issue-details" style="margin-top: 8px;">
                  üí° ${issue.suggestion}
                </div>
              ` : ''}
              <div class="issue-fix">
                <button class="btn btn-sm btn-secondary" onclick="jumpToElement('${issue.elementId}')">
                  üîç Find
                </button>
                ${issue.suggestedFix ? `
                  <button class="btn btn-sm btn-primary" onclick="applyFix(${issue.index})">
                    ‚úì Fix
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        });
      });

      container.innerHTML = html;
    }

    function jumpToElement(elementId) {
      parent.postMessage({
        pluginMessage: {
          type: 'jump-to-element',
          elementId: elementId
        }
      }, '*');
    }

    function applyFix(index) {
      parent.postMessage({
        pluginMessage: {
          type: 'apply-fix',
          issueIndex: index
        }
      }, '*');
    }

    // ==========================================
    // HISTORY
    // ==========================================
    function loadHistory() {
      const container = document.getElementById('history-container');
      
      // Clear any existing timeout
      if (historyLoadTimeout) {
        clearTimeout(historyLoadTimeout);
      }
      
      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading history...</p>
        </div>
      `;
      
      // Set a timeout to show "no history" if response doesn't come
      historyLoadTimeout = setTimeout(() => {
        console.log('History load timeout - showing empty state');
        displayHistory([]);
      }, 3000);
      
      parent.postMessage({ pluginMessage: { type: 'get-history' } }, '*');
    }

    function displayHistory(analyses) {
      // Clear the timeout since we got a response
      if (historyLoadTimeout) {
        clearTimeout(historyLoadTimeout);
        historyLoadTimeout = null;
      }
      
      const container = document.getElementById('history-container');
      
      if (!analyses || analyses.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 24px;">
            <div class="empty-state-icon">üìä</div>
            <h3>No History Yet</h3>
            <p>Analyzed frames will appear here</p>
          </div>
        `;
        return;
      }

      let html = '';
      analyses.forEach(item => {
        const date = new Date(item.analyzedAt);
        const timeAgo = getTimeAgo(date);
        
        html += `
          <div class="history-item" onclick="selectHistoryFrame('${item.frameId}')">
            <div class="history-item-header">
              <span class="history-item-name">${item.frameName}</span>
              <span class="history-item-time">${timeAgo}</span>
            </div>
            <div class="history-item-stats">
              ${item.failCount > 0 ? `<span class="badge badge-destructive">${item.failCount} Critical</span>` : ''}
              ${item.warnCount > 0 ? `<span class="badge badge-warning">${item.warnCount} Warnings</span>` : ''}
              ${item.failCount === 0 && item.warnCount === 0 ? `<span class="badge badge-success">‚úì Passed</span>` : ''}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      return date.toLocaleDateString();
    }

    function selectHistoryFrame(frameId) {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'select-frame',
          frameId: frameId 
        } 
      }, '*');
      switchTab('analyze');
    }

    function clearHistory() {
      if (confirm('Clear all analysis history?')) {
        parent.postMessage({ pluginMessage: { type: 'clear-history' } }, '*');
        displayHistory([]);
        showToast('History Cleared', 'All history has been removed', 'success');
      }
    }

    // ==========================================
    // SETTINGS
    // ==========================================
    const wcagDescriptions = {
      '2.0-AA': 'WCAG 2.0 AA: Basic standard, widely supported.',
      '2.0-AAA': 'WCAG 2.0 AAA: Stricter contrast requirements.',
      '2.1-AA': 'WCAG 2.1 AA: Recommended. Includes mobile accessibility.',
      '2.1-AAA': 'WCAG 2.1 AAA: Enhanced mobile requirements.',
      '2.2-AA': 'WCAG 2.2 AA: Latest standard (2023).',
      '2.2-AAA': 'WCAG 2.2 AAA: Strictest requirements.',
    };

    function updateWCAGDescription() {
      const version = document.getElementById('wcag-version').value;
      const level = document.getElementById('wcag-level').value;
      const key = `${version}-${level}`;
      document.getElementById('wcag-description').textContent = wcagDescriptions[key] || '';
    }

    function updateOpacityValue(value) {
      document.getElementById('opacity-value').textContent = `${value}%`;
    }

    function loadSettings() {
      parent.postMessage({ pluginMessage: { type: 'get-settings' } }, '*');
    }

    function populateSettings(settings) {
      if (!settings) return;

      if (settings.wcag) {
        const versionSelect = document.getElementById('wcag-version');
        const levelSelect = document.getElementById('wcag-level');
        if (versionSelect) versionSelect.value = settings.wcag.version || '2.1';
        if (levelSelect) levelSelect.value = settings.wcag.level || 'AA';
        updateWCAGDescription();
      }

      if (settings.checks) {
        document.getElementById('check-color-contrast').checked = settings.checks.colorContrast !== false;
        document.getElementById('check-text-spacing').checked = settings.checks.textSpacing !== false;
        document.getElementById('check-line-height').checked = settings.checks.lineHeight !== false;
        document.getElementById('check-paragraph-spacing').checked = settings.checks.paragraphSpacing !== false;
        document.getElementById('check-non-text-contrast').checked = settings.checks.nonTextContrast !== false;
      }

      if (settings.display) {
        document.getElementById('show-overlays').checked = settings.display.showOverlays !== false;
        document.getElementById('group-by-element').checked = settings.display.groupByElement !== false;
        document.getElementById('show-only-failures').checked = settings.display.showOnlyFailures === true;
        
        const opacity = settings.display.overlayOpacity || 70;
        document.getElementById('overlay-opacity').value = opacity;
        updateOpacityValue(opacity);
      }

      if (settings.cache) {
        document.getElementById('cache-ttl').value = settings.cache.ttlDays || 7;
      }
    }

    function saveSettings() {
      const settings = {
        wcag: {
          version: document.getElementById('wcag-version').value,
          level: document.getElementById('wcag-level').value,
        },
        checks: getEnabledChecks(),
        display: {
          showOverlays: document.getElementById('show-overlays').checked,
          groupByElement: document.getElementById('group-by-element').checked,
          showOnlyFailures: document.getElementById('show-only-failures').checked,
          overlayOpacity: parseInt(document.getElementById('overlay-opacity').value),
        },
        cache: {
          ttlDays: parseInt(document.getElementById('cache-ttl').value),
        },
      };
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-settings',
          settings: settings 
        } 
      }, '*');
      
      showToast('Settings Saved', 'Your preferences have been updated', 'success');
    }

    function clearAllCache() {
      if (confirm('Clear all saved analysis results? This will make future analyses start fresh.')) {
        parent.postMessage({ pluginMessage: { type: 'clear-all-cache' } }, '*');
        showToast('Data Cleared', 'All saved results have been removed', 'success');
      }
    }

    // ==========================================
    // TOAST
    // ==========================================
    function showToast(title, message, type = 'info') {
      const container = document.getElementById('toast-container');
      const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || '‚Ñπ'}</div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
      `;
      
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // ==========================================
    // MESSAGE HANDLER
    // ==========================================
    window.addEventListener('message', (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      console.log('UI received:', msg.type);

      switch (msg.type) {
        case 'frame-selected':
          // Display ONLY the frame name
          updateFrameCard(msg.frameName, msg.hasCache);
          break;

        case 'frame-deselected':
        case 'selection-error':
          clearFrameCard();
          if (msg.message) {
            showToast('Selection', msg.message, 'warning');
          }
          break;

        case 'analysis-started':
          document.getElementById('progress-container').classList.remove('hidden');
          document.getElementById('progress-fill').style.width = '0%';
          document.getElementById('progress-text').textContent = 'Analyzing...';
          break;

        case 'analysis-progress':
          document.getElementById('progress-fill').style.width = (msg.progress || 0) + '%';
          document.getElementById('progress-text').textContent = `Checking ${msg.current}/${msg.total} elements`;
          break;

        case 'analysis-complete':
          displayResults(msg.issues, msg.totalIssues, msg.fromCache, msg.cacheAge);
          break;

        case 'analysis-error':
          document.getElementById('progress-container').classList.add('hidden');
          document.getElementById('analyze-btn').disabled = false;
          isAnalyzing = false;
          showToast('Error', msg.message || 'Analysis failed', 'error');
          break;

        case 'settings-loaded':
          populateSettings(msg.settings);
          break;

        case 'settings-saved':
          // Already showing toast in saveSettings()
          break;

        case 'history-loaded':
          displayHistory(msg.analyses);
          break;

        case 'history-cleared':
          displayHistory([]);
          break;

        case 'cache-cleared':
          showToast('Data Cleared', 'Saved results have been removed', 'success');
          break;

        case 'fix-applied':
          showToast('Fix Applied', msg.message || 'The fix was applied successfully', 'success');
          break;

        case 'error':
          showToast('Error', msg.message || 'Something went wrong', 'error');
          break;
      }
    });

    // ==========================================
    // OVERLAY TOGGLE
    // ==========================================
    let showOverlay = true;

    function toggleOverlay(checked) {
      showOverlay = checked;
      
      // Sync with settings checkbox
      const settingsCheckbox = document.getElementById('show-overlays');
      if (settingsCheckbox) {
        settingsCheckbox.checked = checked;
      }
      
      // Preference persistence handled when user saves settings (via Save Settings)
      
      // Tell plugin to show/hide overlays
      parent.postMessage({ 
        pluginMessage: { 
          type: 'toggle-overlay',
          show: checked
        } 
      }, '*');
    }

    function restoreOverlayState() {
      // Overlay state will be initialized from plugin settings via `settings-loaded` message.
    }

    // Sync settings checkbox with analyze page toggle
    document.getElementById('show-overlays')?.addEventListener('change', function(e) {
      const toggle = document.getElementById('show-overlay-toggle');
      if (toggle) toggle.checked = e.target.checked;
      showOverlay = e.target.checked;
      // Persistence will occur when user clicks Save Settings
    });

    // ==========================================
    // INIT
    // ==========================================
    console.log('A11y Audit Pro UI initialized');
    updateWCAGDescription();
    // Request saved settings from plugin (figma.clientStorage -> code.ts)
    try { loadSettings(); } catch (e) { /* ignore if unavailable */ }
    restoreCollapsibleState();
    restoreOverlayState();
  </script>
</body>
</html>
